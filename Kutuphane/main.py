from flask import Flask, render_template, send_file, request, render_template_string, redirect, url_for
import pandas as pd
import os

app = Flask(__name__)
app.secret_key = 'gizli_anahtar'

# üî¥ Dosya tabanlƒ± okunanlar listesi
OKUNANLAR_DOSYASI = "okunanlar.txt"

def oku_okunanlar():
    if not os.path.exists(OKUNANLAR_DOSYASI):
        return []
    with open(OKUNANLAR_DOSYASI, "r") as f:
        return [line.strip() for line in f.readlines()]

def ekle_okunan(barkod):
    with open(OKUNANLAR_DOSYASI, "a") as f:
        f.write(barkod + "\n")

def sifirla_okunanlar():
    if os.path.exists(OKUNANLAR_DOSYASI):
        os.remove(OKUNANLAR_DOSYASI)

@app.route('/')
def home():
    return render_template("index.html")

@app.route('/sablon-bos-indir')
def sablon_bos_indir():
    return send_file("sablon_bos.xlsx", as_attachment=True)

@app.route('/sablon-indir')
def sablon_indir():
    if os.path.exists("sablon.xlsx"):
        return send_file("sablon.xlsx", as_attachment=True)
    else:
        return "‚ö†Ô∏è Hen√ºz y√ºklenmi≈ü bir dosya yok."

@app.route('/dosya-sil')
def dosya_sil():
    if os.path.exists("sablon.xlsx"):
        os.remove("sablon.xlsx")
    sifirla_okunanlar()
    return redirect(url_for('home'))

@app.route('/yukle', methods=['POST'])
def yukle():
    dosya = request.files['dosya']
    if dosya:
        dosya.save("sablon.xlsx")
        df = pd.read_excel("sablon.xlsx")
        html_tablo = df.to_html(classes='table table-bordered', index=False)
        return render_template_string(f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Y√ºklenen Kitap Listesi</title>
            <style>
                table, th, td {{
                    border: 1px solid black;
                    border-collapse: collapse;
                    padding: 5px;
                }}
            </style>
        </head>
        <body>
            <h2>üìö Y√ºklenen Kitap Listesi</h2>
            {html_tablo}
            <br><br>
            <a href="/">‚¨ÖÔ∏è Geri D√∂n</a>
        </body>
        </html>
        """)
    else:
        return "‚ö†Ô∏è Dosya y√ºklenemedi!"

@app.route('/sayim', methods=['GET', 'POST'])
def sayim():
    try:
        df = pd.read_excel("sablon.xlsx")
    except FileNotFoundError:
        return "‚ùå Hata: sablon.xlsx dosyasƒ± bulunamadƒ±. L√ºtfen √∂nce dosya y√ºkleyin."

    kitap = None
    mesaj = None
    okunanlar = oku_okunanlar()

    if request.method == "POST":
        barkod = request.form.get("barkod")
        if len(barkod) == 13:
            barkod = barkod[:12]

        if barkod in okunanlar:
            mesaj = "‚ö†Ô∏è Bu barkod zaten okutuldu!"
        else:
            satir = df[df["Barkod"].astype(str) == barkod]
            if not satir.empty:
                kitap = satir.iloc[0].to_dict()
                ekle_okunan(barkod)
                okunanlar.append(barkod)  # G√∂r√ºnt√ºleme i√ßin listeyi g√ºncelle
            else:
                mesaj = "üö´ Bu barkod sistemde bulunamadƒ±."

    return render_template("sayim.html", kitap=kitap, mesaj=mesaj, okunanlar=okunanlar)

app.run(host='0.0.0.0', port=81, debug=False)
